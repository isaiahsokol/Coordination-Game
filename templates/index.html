<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game Waiting Room</title>
    <style>
        body { font-family: sans-serif; text-align: center; margin-top: 50px; }
        .hidden { display: none;}

        #input-modal-overlay.hidden {
            display: none;
        }

        #login-view, #game-view {
            max-width: 500px;
            margin: auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        #login-view button, #login-view input {
            font-size: 1.1em;
            padding: 8px;
            margin: 5px;
        }
        #room-code-display {
            font-size: 1.5em;
            font-weight: bold;
            color: #007BFF;
            margin: 15px;
        }
        #status-message { font-size: 1.1em; color: #555; }
        #game-view { background-color: #f4f4f4; }
        
        #game-board-view {
            margin-top: 20px;
        }
        #board {
            background-color: white;
            border: 2px dashed #aaa;
            border-radius: 5px;
            min-height: 100px;
            padding: 10px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-content: flex-start;
        }
        #hand {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .number-card {
            font-size: 1.5em;
            font-weight: bold;
            padding: 20px;
            width: 60px;
            border: 1px solid #777;
            border-radius: 5px;
            background-color: #fff;
            cursor: pointer;
        }
        .number-card:hover { background-color: #f0f0f0; }

        .played-card {
            font-size: 1.2em;
            padding: 10px 15px;
            border: 1px solid #bbb;
            border-radius: 5px;
            background-color: #eee;
        }

        .mistake-card {
            background-color: #ffcccc;
            border-color: #cc0000;
        }

        #mistake-notice {
            color: red;
            font-weight: bold;
            font-size: 1.2em;
            height: 1.5em; /* Reserve space so it doesn't jump */
        }

        #next-round-btn {
            font-size: 1.2em;
            padding: 10px 20px;
            margin-top: 20px;
            cursor: pointer;
        }

        .modal-overlay {
            position: fixed; /* Sit on top of the page */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6); /* Dark backdrop */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #input-modal-content {
            background: #fff;
            padding: 20px 30px;
            border-radius: 8px;
            text-align: center;
            width: 400px;
        }

        #input-modal-content input {
            font-size: 1.2em;
            padding: 8px;
            width: 80%;
            margin: 15px 0;
        }
        #input-modal-content button {
            font-size: 1.1em;
            padding: 10px 20px;
            cursor: pointer;
        }

        #reset-round-btn {
            background-color: #f8d7da; /* A light red */
            border: 1px solid #f5c2c7;
            color: #721c24;
            padding: 5px 10px;
            margin-bottom: 10px;
            cursor: pointer;
            border-radius: 4px;
        }
        #reset-round-btn:hover {
            background-color: #f5c2c7;
        }

        #countdown-overlay.hidden {
            display: none;
        }

        #countdown-content {
            background: #fff;
            padding: 30px 50px;
            border-radius: 8px;
            text-align: center;
        }

        #countdown-timer {
            font-size: 4em;
            font-weight: bold;
            color: #007BFF;
            line-height: 1;
        }
    </style>
</head>
<body>
    <div id="login-view">
        <h2>Coordination Game</h2>
        <button id="create-btn">Create New Game</button>
        <hr style="margin: 20px;">
        <input type="text" id="room-code-input" placeholder="Enter Room Code">
        <button id="join-btn">Join Game</button>
        <div id="room-code-display"></div>
        <div id="status-message"></div>
    </div>

    <div id="game-view" class="hidden">
        <h2 id="game-status-text">Partner has joined!</h2>
        <button id="start-game-btn">Start Game</button>
        
        <div id="game-board-view" class="hidden">
            <button id="reset-round-btn">Reset Current Round</button>

            <div id="mistake-notice"></div>
        
            <h3>Previous numbers:</h3>
            <div id="board">
                </div>
            
            <h3>Your Hand:</h3>
            <div id="hand">
                </div>
            <button id="next-round-btn" class="hidden">Next Round</button>

        </div>
    </div>

    <div id="input-modal-overlay" class="modal-overlay hidden">
        <div id="input-modal-content">
            
            <div id="input-view">
                <p id="input-prompt-message"></p>
                <input type="number" id="number-input" placeholder="Enter a number">
                <button id="submit-input-btn">Submit</button>
            </div>

            <div id="waiting-view" class="hidden">
                <h2>You played a number!</h2>
                <p>Waiting for your partner to submit their input...</p>
            </div>

        </div>
    </div>

    <div id="countdown-overlay" class="modal-overlay hidden">
        <div id="countdown-content">
            <h2 id="countdown-message"></h2>
            <div id="countdown-timer">3</div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <script type="text/javascript">
        const socket = io();

        // ---Login View Elements ---
        const loginView = document.getElementById('login-view');
        const gameView = document.getElementById('game-view');
        const createBtn = document.getElementById('create-btn');
        const joinBtn = document.getElementById('join-btn');
        const roomCodeInput = document.getElementById('room-code-input');
        const roomCodeDisplay = document.getElementById('room-code-display');
        const statusMessage = document.getElementById('status-message');

        // --- Game View Elements ---
        const gameStatusText = document.getElementById('game-status-text');
        const startGameBtn = document.getElementById('start-game-btn');
        const gameBoardView = document.getElementById('game-board-view');
        const boardDiv = document.getElementById('board');
        const handDiv = document.getElementById('hand');
        const mistakeNotice = document.getElementById('mistake-notice');
        
        const nextRoundBtn = document.getElementById('next-round-btn');

        const inputModalOverlay = document.getElementById('input-modal-overlay');
        const inputView = document.getElementById('input-view');
        const waitingView = document.getElementById('waiting-view');
        const numberInput = document.getElementById('number-input');
        const submitInputBtn = document.getElementById('submit-input-btn');

        const resetRoundBtn = document.getElementById('reset-round-btn');

        const countdownOverlay = document.getElementById('countdown-overlay');
        const countdownMessage = document.getElementById('countdown-message');
        const countdownTimer = document.getElementById('countdown-timer');
                
        createBtn.addEventListener('click', () => { socket.emit('create_room'); });
        joinBtn.addEventListener('click', () => {
            const code = roomCodeInput.value.trim().toUpperCase();
            if (code) { socket.emit('join_room', { 'room_code': code }); }
        });
        startGameBtn.addEventListener('click', () => {
            socket.emit('start_game');
            startGameBtn.classList.add('hidden');
            gameStatusText.textContent = "Waiting for server...";
        });

        nextRoundBtn.addEventListener('click', () => {
            nextRoundBtn.classList.add('hidden');
            socket.emit('start_next_round');
            gameStatusText.textContent = "Loading next round...";
        });

        submitInputBtn.addEventListener('click', () => {
            const data = numberInput.value;
            if (data === '') {
                alert('Please enter a value.');
                return;
            }
            
            console.log('Submitting input:', data);
            submitInputBtn.disabled = true;
            socket.emit('submit_input', { 'input_data': data });
        });

        // --- Listen for server events ---
        socket.on('room_created', (msg) => {
            roomCodeDisplay.textContent = `Room Code: ${msg.room_code}`;
            statusMessage.textContent = 'Waiting for partner to join...';
            createBtn.disabled = true;
            joinBtn.disabled = true;
        });

        socket.on('game_ready', () => {
            loginView.classList.add('hidden');
            gameView.classList.remove('hidden');
        });
        
        socket.on('game_started', (msg) => {
            console.log('Game started!', msg);
            
            // 1. Get all the data from the server
            const hand = msg.hand;
            const board = msg.board;

            // 2. Update all the *non-game* UI immediately
            startGameBtn.classList.add('hidden');
            nextRoundBtn.classList.add('hidden');
            inputModalOverlay.classList.add('hidden');
            gameStatusText.textContent = `Set ${msg.set} - Round ${msg.round} in Progress!`;
            gameBoardView.classList.remove('hidden');
            
            // 3. Define the function to run *after* the countdown
            const onCountdownComplete = () => {
                renderHand(hand);
                renderBoard(board);
            };

            // 4. Start the countdown
            if (msg.set === 1) {
                document.body.style.backgroundColor = '#ffffff';
            } else {
                document.body.style.backgroundColor = '#f0f5ff';
            }
            startCountdown(`Round ${msg.round} starts in...`, onCountdownComplete);
        });
                
        socket.on('game_state_update', (msg) => {
            console.log('Game state update received:', msg);

            // 1. Get the data
            const hand = msg.hand;
            const board = msg.board;
            
            // 2. Hide the input modal immediately
            inputModalOverlay.classList.add('hidden');

            // 3. Define the function to run *after* the countdown
            const onCountdownComplete = () => {
                renderHand(hand);
                renderBoard(board);
            };

            // 4. Start the countdown
            startCountdown('Game resumes in...', onCountdownComplete);
        });
        
        socket.on('mistake_notice', (msg) => {
            console.log('Mistake notice:', msg);
            mistakeNotice.textContent = `Oh no! ${msg.value} was played, but ${msg.correct_value} was next :(`;
            // Clear the message after 3 seconds
            setTimeout(() => {
                mistakeNotice.textContent = '';
            }, 3000);
        });

        socket.on('error_message', (msg) => {
            statusMessage.textContent = msg.message;
            statusMessage.style.color = 'red';
        });

        socket.on('request_input', (msg) => {
            console.log('Server is requesting input.');
            inputModalOverlay.classList.remove('hidden');
            inputView.classList.remove('hidden');
            waitingView.classList.add('hidden');
            numberInput.value = '';
            submitInputBtn.disabled = false;
            
            const promptMessage = document.getElementById('input-prompt-message');
            if (msg.set === 1) {
                promptMessage.textContent = 'How close were you to playing? (1=not at all close, 10=literally already moving your finger to press the button)';
            } else {
                promptMessage.textContent = 'What number have you counted to?';
            }
        });

        socket.on('wait_for_input', () => {
            console.log('We played, now waiting for partner.');
            inputModalOverlay.classList.remove('hidden');
            inputView.classList.add('hidden');
            waitingView.classList.remove('hidden');
        });

        socket.on('round_over', (msg) => {
            console.log('Round over:', msg);
            gameStatusText.textContent = `Round ${msg.round} finished with ${msg.mistakes} mistakes.`;
            nextRoundBtn.classList.remove('hidden');
        });

        socket.on('game_over', (msg) => {
            console.log('Game over:', msg);
            gameStatusText.textContent = `Congrats, you two were very impressive!!! Thank you for Playing :)`;
            nextRoundBtn.classList.add('hidden');
            handDiv.innerHTML = '';
        });

        resetRoundBtn.addEventListener('click', () => {
            // Add a confirmation to prevent accidental clicks
            if (confirm('Are you sure you want to reset this round? All progress for this round will be lost.')) {
                console.log('Emitting reset_round');
                socket.emit('reset_round');
            }
        });

        function renderHand(handArray) {
            handDiv.innerHTML = ''; // Clear the hand
            for (const number of handArray) {
                const cardButton = document.createElement('button');
                cardButton.textContent = number;
                
                cardButton.addEventListener('click', () => {
                    console.log('Emitting play_number:', number);
                    cardButton.disabled = true;
                    socket.emit('play_number', { 'value': number });
                });
                
                handDiv.appendChild(cardButton);
            }
        }
       
        function renderBoard(boardArray) {
            boardDiv.innerHTML = ''; // Clear the board
            if (boardArray.length === 0) {
                boardDiv.textContent = 'Played numbers will appear here.';
            } else {
                for (const play of boardArray) {
                    const playedCard = document.createElement('div');
                    playedCard.textContent = play.value;
                    playedCard.classList.add('played-card');
                    if (play.isMistake) {
                        playedCard.classList.add('mistake-card');
                    }
                    boardDiv.appendChild(playedCard);
                }
            }
        }

        function startCountdown(message, onComplete) {
            // Show the overlay
            countdownMessage.textContent = message;
            countdownOverlay.classList.remove('hidden');
            
            let count = 3;
            countdownTimer.textContent = count;

            const interval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownTimer.textContent = count;
                } else {
                    clearInterval(interval);
                    countdownOverlay.classList.add('hidden');
                    onComplete(); // Run the function we passed in
                }
            }, 1000); // Run every 1 second
        }
    </script>
    <div>
        <h1>Instructions:</h1>
        <p>Create or join a room to play with a partner</p>
        <p>This is a test of how in sync you are with your partner.
            Your task is to determine when to play each your 5 numbered cards (ranging from 1 to 100) in such a way that between the two of you, your cards are played in order from lowest to highest.
            The only problem is there is no communication of any kind allowed.
            The game will be played in two "sets" of 5 rounds each.
            In the first set (rounds 1-5), go based on vibes. Play your cards when it feels right.
            After each card your oponent plays, you will be asked to rank how close you were to playing your next card between 1 (not close at all) and 10 (just about to play).
            Don't worry if you mess one up every so often, it's part of the game! Just continue from where you left off.
            In the second set (rounds 6-10), try to count in your head. When you reach a number in your hand, play it.
            There is no "correct" speed to cound at, but you should try to match your partner. 
            Again, after each time your partner plays a number, you will be asked to provide some information.
            This time, type in the number you had counted to up to that point.
            Use the "Reset round" button **ONLY** if you think you are soft locked.
            With great power comes great responsiblity...
        </p>
        <h3>Good luck!!!</h3>
    </div>
</body>
</html>
